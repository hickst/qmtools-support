# QMTools Violin

This is a public code repository of the [Translational BioImaging Resource–MRI](https://research.arizona.edu/facilities/core-facilities/translational-bioimaging-resource-mri) core group at the [University of Arizona](https://www.arizona.edu/).

**Authors**: [Tom Hicks](https://github.com/hickst) and [Dianne Patterson](https://github.com/dkp)

**About**: This document describes the Violin tool of the [QMTools project](https://github.com/hickst/qmtools). Violin compares two sets of MRIQC image quality metrics and creates an HTML report, using Violin plots to visualize how the two groups compare for each IQM. The two datasets to be compared can both be user-generated OR both fetched from the MRIQC database OR one of each.

## Using the Violin Tool

### **Prerequisite**: Install the QMTools Support project

Follow the instructions on this project's [main page](https://github.com/hickst/qmtools-support) to install the project which the Violin script (**qmviolin**) and this document are a part of.

### **Prerequisite**: Docker

You must have Docker installed and working on your machine to use this project. For instructions on how to install Docker see [this link](https://docs.docker.com/get-docker/).

### **Step 1**: Ensure the required inputs file are available

The **qmviolin** script compares two files, each containing an MRIQC-related dataset. The two datasets to be compared can both be group files generated by the MRIQC program OR two datasets fetched from the MRIQC database OR a combination of one of each. All datasets used by the **qmviolin** program, **MUST** be in the `inputs` directory and/or the `fetched` directory. Use of these directories is consistent with the operation of the [TrafficLight](https://github.com/hickst/qmtools-support/blob/main/docs/TrafficLight.md) tool and the [Fetcher](https://github.com/hickst/qmtools-support/blob/main/docs/Fetcher.md) tool, respectively.

The most straightforward use case for **qmviolin** is the comparison of a single MRIQC group file against a dataset fetched from the MRIQC server. This is the case where a researcher wishes to compare their IQM results against results obtained by other users, available from the MRIQC server. In this scenario, the researcher will copy an MRIQC group file into the `inputs` directory and use the Fetcher program to query for and retrieve a dataset into the `fetched` directory.

Another potentially useful scenario is the comparison of two fetched datasets with different query parameters. This can be used to compare datasets collected with different collection parameters.

Two MRIQC group files can also be compared directly. This might be useful for comparing the quality of images collected under different conditions or involving different populations.

### **Step 2**: Run the **qmviolin** Script

Each tool includes an associated script which runs the tool within the QMTools Docker container, and makes the appropriate subdirectories available to the container (via a Docker *bind mount*):

To produce a Violin report, run the **qmviolin** script at the command line, specifying the modality and the relative paths to the two MRIQC dataset files. Optionally, you may also specify the name of an output directory, within the main `reports` directory, where the report files will be saved.

**Note**: that from the **qmviolin** program's perspective it is always comparing a reference dataset (the `fetched` dataset) against a user generated dataset (the `group` dataset). But, as previously noted, the two datasets may also be both fetched or both generated. The first dataset specified will always be taken as the reference (`fetched`) dataset.

**Example 1**: Run the Violin report for an MRIQC group file against a previously fetched dataset:
```
  > qmviolin -v bold fetched/sample_fetched.tsv inputs/sample_bold.tsv 
```

***Note**: It is highly recommended to use the **verbose mode flag** (`-v` or `--verbose`) to produce informational messages while processing, unless you have a specific reason not to do so (such as running a QMTools script embedded within another script).*

If no problems are encountered while running the program, you should see status messages, such as these:
```
  > qmviolin -v bold fetched/sample_fetched.tsv inputs/sample_bold.tsv

(qmviolin): Comparing MRIQC records with modality 'bold'.
(qmviolin): Compared group records against fetched records.
(qmviolin): Produced violin report to 'reports/bold_20211007_014317-628002'.
(qmviolin): To see the report: open 'reports/bold_20211007_014317-628002/violin.html' in a browser.
```

 Note that, in Verbose mode, the path to the report HTML file is displayed, making it easy to select this file and display the report in a browser (see **Step 3**).

**Example 2**: Run the Violin report for an MRIQC group file against another MRIQC group file and save the report files in a `reports` subdirectory called `qual_check`:
```
  > qmviolin -v bold inputs/typicals_bold.tsv inputs/lds_bold.tsv -r qual_check

(qmviolin): Comparing MRIQC records with modality 'bold'.
(qmviolin): Compared group records against fetched records.
(qmviolin): Produced violin report to 'reports/qual_check'.
(qmviolin): To see the report: open 'reports/qual_check/violin.html' in a browser.
```

**Example 3**: Run the Violin report for a previously fetched dataset against another previously fetched dataset and save the report files in a `reports` subdirectory called `scanners`:
```
  > qmviolin -v bold fetched/siemens.tsv fetched/ge.tsv -r scanners

(qmviolin): Comparing MRIQC records with modality 'bold'.
(qmviolin): Compared group records against fetched records.
(qmviolin): Produced violin report to 'reports/scanners'.
(qmviolin): To see the report: open 'reports/scanners/violin.html' in a browser.
```

### Getting Usage Help for a Tool

To see a help (usage) message for a QMTool, call the tool script with the special ***help flag*** (`-h` or `--help`):
```
  > qmviolin -h

usage: qmviolin [-h] [-v] [-r REPORT_DIR] {bold,T1w,T2w} fetched_file group_file

Produce a report with violin plots comparing two MRIQC datasets.

positional arguments:
  {bold,T1w,T2w}        Modality of the MRIQC files. Must be one of: ['bold', 'T1w', 'T2w']
  fetched_file          Path to an MRIQC downloaded/fetched file (.tsv) to compare against.
  group_file            Path to the MRIQC group file (.tsv) to process.

optional arguments:
  -h, --help            show this help message and exit
  -v, --verbose         Print informational messages during processing [default: False (non-verbose mode)].
  -r REPORT_DIR, --report-dir REPORT_DIR
                        Optional name of report subdirectory in main reports directory [default: none]
```

### **Step 3**: View the Violin Report

When run in Verbose mode (using the `-v` or `--verbose` flag), QMTools which produce reports will show the path to the HTML report file, which can then be opened in a browser window. Tools which fetch or create data files will display the path to the directory containing those files.

The Violin program saves the files which comprise the Violin report in a subdirectory of the `reports` directory. If you do not explicitly specify a subdirectory name (using the `-r` or `--report-dir` option) then a timestamped directory name is generated. (e.g., `bold_20211007_014317-628002` in **Example 1** above).

The report may then be displayed in a browser by opening the `violin.html` file from the named (or generated) `reports` subdirectory:

**Example 1**: View the Violin report generated in **Example 1** above:
```
  > open reports/bold_20211007_014317-628002/violin.html
```

**Example 2**: View the Violin report generated in **Example 2** above:
```
  > open reports/qual_check/violin.html
```

**Example 3**: View the Violin report generated in **Example 3** above:
```
  > open reports/scanners/violin.html
```

## License

This software is licensed under Apache License Version 2.0.

Copyright (c) The University of Arizona, 2021. All rights reserved.
